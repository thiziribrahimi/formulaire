const express = require("express");
const cors = require("cors");
const bodyParser = require("body-parser");
const fetch = require("node-fetch"); // Assure-toi d'avoir node-fetch@2 install√©

const app = express();
const PORT = 4000;

app.use(cors());
app.use(bodyParser.json());

// ‚úÖ AIRTABLE CONFIG POUR LES CODES PROMO - CORRIG√â
const AIRTABLE_BASE_ID = "appLAFIAMjHg6ZEuQ"; // ‚úÖ BASE ID CORRECT
const AIRTABLE_TABLE_NAME = "tblZxqrnc80BmO6Dg"; // ‚úÖ NOUVEAU ID DE TABLE CORRIG√â
const AIRTABLE_API_KEY = "patzYVfCYwQWH3Mng.7ca9bb3a21a7976826e5a395e4ac4c01649307f3638b8f463e6d774a5de5f598"; // Votre jeton personnel

// üîç ENDPOINT DE DEBUG : Lister les tables disponibles
app.get("/api/listTables", async (req, res) => {
  try {
    console.log("üîç Test de connexion √† Airtable...");
    console.log("üìã Base ID:", AIRTABLE_BASE_ID);
    console.log("üîë API Key (premiers caract√®res):", AIRTABLE_API_KEY.substring(0, 15) + "...");
    
    const response = await fetch(`https://api.airtable.com/v0/meta/bases/${AIRTABLE_BASE_ID}/tables`, {
      headers: {
        "Authorization": `Bearer ${AIRTABLE_API_KEY}`,
        "Content-Type": "application/json"
      }
    });

    const data = await response.json();
    console.log("üìä Statut de la r√©ponse:", response.status);
    console.log("üìä R√©ponse compl√®te:", JSON.stringify(data, null, 2));
    
    if (data.tables) {
      console.log("üìã Tables trouv√©es:");
      data.tables.forEach(table => {
        console.log(`  - "${table.name}" (ID: ${table.id})`);
        if (table.fields) {
          console.log(`    Champs disponibles:`);
          table.fields.forEach(field => {
            console.log(`      - "${field.name}" (Type: ${field.type})`);
          });
        }
      });
    }
    
    res.json(data);
  } catch (error) {
    console.error("‚ùå Erreur lors de la r√©cup√©ration des tables:", error);
    res.status(500).json({ error: error.message });
  }
});

// üîç NOUVEAU ENDPOINT : Voir le contenu de la table des codes promo
app.get("/api/debugPromoTable", async (req, res) => {
  try {
    console.log("üîç Debug de la table des codes promo...");
    
    const airtableUrl = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`;
    
    const response = await fetch(airtableUrl, {
      headers: {
        "Authorization": `Bearer ${AIRTABLE_API_KEY}`,
        "Content-Type": "application/json"
      }
    });

    const data = await response.json();
    console.log("üìä Statut HTTP de la r√©ponse:", response.status);
    console.log("üìä R√©ponse compl√®te:", JSON.stringify(data, null, 2));
    
    if (data.records && data.records.length > 0) {
      console.log("üìã Premier enregistrement trouv√©:");
      console.log("üìã Champs disponibles:", Object.keys(data.records[0].fields));
      console.log("üìã Donn√©es:", JSON.stringify(data.records[0].fields, null, 2));
    }
    
    res.json(data);
  } catch (error) {
    console.error("‚ùå Erreur lors du debug:", error);
    res.status(500).json({ error: error.message });
  }
});

// üîç ENDPOINT : V√©rifier un code promo
app.post("/api/verifyPromoCode", async (req, res) => {
  const { code } = req.body;
  
  console.log("üöÄ ENDPOINT APPEL√â !");
  console.log("üì® Body re√ßu:", req.body);
  console.log("üîç Tentative de v√©rification du code:", code);

  if (!code || !code.trim()) {
    console.log("‚ùå Code promo vide ou manquant");
    return res.status(400).json({ 
      error: "Code promo requis",
      valid: false 
    });
  }

  try {
    // üì° Appel √† l'API Airtable pour chercher le code
    const airtableUrl = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`;
    const searchCode = code.trim().toUpperCase();
    
    // ‚úÖ TESTER DIFF√âRENTS NOMS DE CHAMPS POSSIBLES AVEC ENCODAGE CORRECT
    const possibleFieldNames = [
      "Nom du code",
      "Nom%20du%20code", 
      "Code", 
      "code", 
      "Code promo", 
      "Nom", 
      "Name"
    ];
    
    let foundData = null;
    let workingFieldName = null;
    
    // Essayer chaque nom de champ possible
    for (const fieldName of possibleFieldNames) {
      // Encodage manuel pour les espaces
      const encodedFieldName = fieldName.includes(' ') ? 
        fieldName.replace(/ /g, '%20') : 
        fieldName;
      
      const filterFormula = `{${fieldName}}="${searchCode}"`;
      const encodedFormula = encodeURIComponent(filterFormula);
      const fullUrl = `${airtableUrl}?filterByFormula=${encodedFormula}`;
      
      console.log(`üîç Tentative avec le champ: "${fieldName}"`);
      console.log("üìã Formule de filtrage:", filterFormula);
      console.log("üìã Formule encod√©e:", encodedFormula);
      console.log("üåê URL compl√®te:", fullUrl);
      
      const response = await fetch(fullUrl, {
        headers: {
          "Authorization": `Bearer ${AIRTABLE_API_KEY}`,
          "Content-Type": "application/json"
        }
      });

      console.log(`üìä Statut HTTP pour "${fieldName}":`, response.status);
      
      const data = await response.json();
      console.log(`üìä R√©ponse pour "${fieldName}":`, JSON.stringify(data, null, 2));
      
      if (response.ok && data.records && data.records.length > 0) {
        console.log(`‚úÖ Code trouv√© avec le champ: "${fieldName}"`);
        foundData = data;
        workingFieldName = fieldName;
        break;
      } else if (!response.ok) {
        console.log(`‚ùå Erreur avec le champ "${fieldName}":`, data.error?.message);
        continue;
      } else {
        console.log(`‚ùå Aucun r√©sultat avec le champ: "${fieldName}"`);
      }
    }

    if (foundData && foundData.records && foundData.records.length > 0) {
      const promoRecord = foundData.records[0].fields;
      
      console.log("‚úÖ Code promo trouv√© dans Airtable!");
      console.log(`‚úÖ Champ qui fonctionne: "${workingFieldName}"`);
      console.log("üìã Donn√©es du record:", JSON.stringify(promoRecord, null, 2));
      
      // üìä Extraire les informations du code promo selon les champs de votre table
      const promoInfo = {
        valid: true,
        code: promoRecord["Nom du code"] || promoRecord["Code"] || promoRecord["code"] || searchCode,
        discountPercentage: promoRecord["Montant √©conomis√©"] || 0,
        description: `Code promo ${promoRecord["Nom du code"] || searchCode} - ${promoRecord["Montant √©conomis√©"] || 0}% de r√©duction`,
        // Ajoutez d'autres champs selon votre structure Airtable
        origin: promoRecord["Origine"] || "",
        clientName: promoRecord["D√©tenteur clients"] || "",
        tutorName: promoRecord["D√©tenteur tuteurs"] || "",
        workingFieldName: workingFieldName // Pour debug
      };

      console.log("‚úÖ Code promo valide retourn√©:", JSON.stringify(promoInfo, null, 2));
      res.status(200).json(promoInfo);
    } else {
      // Code non trouv√© avec aucun des champs
      console.log("‚ùå Code promo non trouv√©:", searchCode);
      console.log("‚ùå Aucun des noms de champs test√©s n'a fonctionn√©");
      res.status(200).json({ 
        valid: false, 
        error: "Code promo invalide ou inexistant",
        debug: `Champs test√©s: ${possibleFieldNames.join(", ")}`
      });
    }

  } catch (error) {
    console.error("‚ùå ERREUR COMPL√àTE lors de la v√©rification du code promo:");
    console.error("‚ùå Message:", error.message);
    console.error("‚ùå Stack:", error.stack);
    res.status(500).json({ 
      valid: false, 
      error: "Erreur lors de la v√©rification du code promo" 
    });
  }
});

// üîÅ Route 1 : Envoi partiel (formulaire final)
app.post("/api/sendToAirtable", async (req, res) => {
  const payload = req.body;

  console.log("üì® Donn√©es re√ßues (final form) :", payload);

  const webhookUrl =
    "https://hooks.airtable.com/workflows/v1/genericWebhook/appZ5bv5TO84S1PtP/wflTHCMH9L6X2qYAV/wtrFSmrHH8ns2LxSw";

  try {
    const response = await fetch(webhookUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(payload),
    });

    let result;
    try {
      result = await response.json();
    } catch (jsonErr) {
      console.warn("‚ö†Ô∏è Airtable (final form) n'a pas renvoy√© de JSON.");
      result = { success: true };
    }

    if (!response.ok) {
      throw new Error(result?.error || "Erreur HTTP Airtable (final form)");
    }

    console.log("‚úÖ R√©ponse Airtable (final form) :", result);
    res.status(200).json({
      message: "Formulaire final envoy√© avec succ√®s",
      airtableResponse: result,
    });
  } catch (err) {
    console.error("‚ùå Erreur (final form) :", err);
    res.status(500).json({ error: "√âchec d'envoi vers le webhook final form" });
  }
});

// üîÅ Route 2 : Envoi complet du dossier
app.post("/api/sendFullDataToAirtable", async (req, res) => {
  const payload = req.body;

  console.log("üì® Donn√©es re√ßues (dossier complet) :", payload);

  const fullWebhookUrl =
    "https://hooks.airtable.com/workflows/v1/genericWebhook/appZ5bv5TO84S1PtP/wflHx1Pcgbb3NbCgo/wtrtILucOysyNwbyZ";

  try {
    const response = await fetch(fullWebhookUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(payload),
    });

    let result;
    try {
      result = await response.json();
    } catch (jsonErr) {
      console.warn("‚ö†Ô∏è Airtable (dossier complet) n'a pas renvoy√© de JSON.");
      result = { success: true };
    }

    if (!response.ok) {
      throw new Error(result?.error || "Erreur HTTP Airtable (dossier complet)");
    }

    console.log("‚úÖ R√©ponse Airtable (dossier complet) :", result);
    res.status(200).json({
      message: "Dossier complet envoy√© avec succ√®s",
      airtableResponse: result,
    });
  } catch (err) {
    console.error("‚ùå Erreur (dossier complet) :", err);
    res
      .status(500)
      .json({ error: "√âchec d'envoi vers le webhook dossier complet" });
  }
});

// üöÄ Lancement du serveur
app.listen(PORT, () => {
  console.log(`‚úÖ Backend running on http://localhost:${PORT}`);
  console.log(`üîç Endpoint code promo: http://localhost:${PORT}/api/verifyPromoCode`);
  console.log(`üîç Endpoint debug tables: http://localhost:${PORT}/api/listTables`);
  console.log(`üîç Endpoint debug table promo: http://localhost:${PORT}/api/debugPromoTable`);
  console.log(`üìã Configuration Airtable:`);
  console.log(`   - Base ID: ${AIRTABLE_BASE_ID}`);
  console.log(`   - Table: "${AIRTABLE_TABLE_NAME}"`);
  console.log(`   - API Key: ${AIRTABLE_API_KEY.substring(0, 15)}...`);
});